name: YouTube Relay Pro Ultra (No-Logo Edition)

on:
  workflow_dispatch:
    inputs:
      link_youtube:
        description: 'Link Video Sumber'
        required: true
      kunci_rtmp:
        description: 'Stream Key YouTube'
        required: true
      po_token:
        description: 'PO Token (Ambil dari ekstensi browser)'
        required: true

jobs:
  streaming:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout
        uses: actions/checkout@v4

      - name: 2. Install Node.js (Pondasi JS Runtime)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 3. Install FFmpeg & yt-dlp Nightly
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg jq curl
          sudo curl -L https://github.com/yt-dlp/yt-dlp-nightly-builds/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          yt-dlp -U

      - name: 4. Menjalankan Relay Streaming
        env:
          YT_COOKIES: ${{ secrets.YT_COOKIES }}
          PO_TOKEN: ${{ github.event.inputs.po_token }}
        run: |
          set +e
          echo "$YT_COOKIES" > cookies.txt
          
          echo "Sistem Siap. Memulai pemantauan..."

          while true; do
            echo "--- [$(date)] Mengecek Link Sumber ---"
            
            # Menggunakan --js-runtime node (Koreksi dari nodejs)
            # Menambahkan PO Token agar tidak kena blokir bot
            VIDEO_URL=$(yt-dlp --cookies cookies.txt \
                               --js-runtime node \
                               --force-ipv4 \
                               --extractor-args "youtube:player_client=mweb,web;po_token=web+$PO_TOKEN" \
                               -f "best[height<=720]" -g "${{ github.event.inputs.link_youtube }}" 2>/dev/null)

            if [ -z "$VIDEO_URL" ]; then
              echo "Gagal mengambil URL. YouTube mendeteksi bot atau PO Token expired."
              echo "Saran: Ambil PO Token baru dan jalankan ulang."
              sleep 15
              continue
            fi

            echo "Berhasil! Memulai Streaming ke YouTube..."

            # FFmpeg versi ringan: Tanpa Filter Complex, Tanpa Overlay
            # Langsung copy stream atau re-encode ringan
            ffmpeg -re -connect_delay 5000 -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 2000 \
              -i "$VIDEO_URL" \
              -c:v libx264 -preset veryfast -b:v 3000k -maxrate 3000k -bufsize 6000k \
              -c:a aac -ar 44100 -b:a 128k \
              -f flv "rtmp://a.rtmp.youtube.com/live2/${{ github.event.inputs.kunci_rtmp }}"

            echo "FFmpeg berhenti/koneksi putus. Mencoba reconnect dalam 5 detik..."
            sleep 5
          done
          
