name: YouTube Relay Pro Ultra

on:
  workflow_dispatch:
    inputs:
      link_youtube:
        description: 'Link Video Utama'
        required: true
      kunci_rtmp:
        description: 'Stream Key YouTube'
        required: true

jobs:
  streaming:
    runs-on: ubuntu-latest
    steps:
      # --- LANGKAH 1: Persiapan Dasar ---
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- LANGKAH 2: Pondasi Utama (Node.js) ---
      # Ini WAJIB di depan agar yt-dlp bisa memanggilnya nanti
      - name: Install Node.js (JavaScript Runtime)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- LANGKAH 3: Install Semua Tools ---
      - name: Install Tools (FFmpeg & yt-dlp)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq curl
          
          # Gunakan versi nightly untuk bypass terbaru
          sudo curl -L https://github.com/yt-dlp/yt-dlp-nightly-builds/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          
          # Verifikasi instalasi
          echo "Node.js Version: $(node -v)"
          echo "yt-dlp Version: $(yt-dlp --version)"

      # --- LANGKAH 4: Persiapan Data & Streaming ---
      - name: Menjalankan Stream
        env:
          YT_COOKIES: ${{ secrets.YT_COOKIES }}
        run: |
          set +e
          
          # Simpan cookies ke file
          echo "$YT_COOKIES" > cookies.txt
          
          # Unduh logo overlay sebelum mulai loop
          echo "Mengunduh logo..."
          yt-dlp --cookies cookies.txt \
                 --js-runtime nodejs \
                 --extractor-args "youtube:player_client=mweb" \
                 -f "best[height<=720]" \
                 "https://youtu.be/zR6n39ZWrJM" -o logo_video.mp4

          # Loop Utama Streaming
          while true; do
            echo "Mengecek Sumber Video..."
            
            # Ambil URL Video menggunakan Node.js sebagai runtime
            VIDEO_URL=$(yt-dlp --cookies cookies.txt \
                               --js-runtime nodejs \
                               --force-ipv4 \
                               --extractor-args "youtube:player_client=mweb,web" \
                               -f "best[height<=720]" -g "${{ github.event.inputs.link_youtube }}" 2>/dev/null)

            if [ -z "$VIDEO_URL" ]; then
              echo "Gagal Ambil URL. Coba lagi dalam 10 detik..."
              sleep 10
              continue
            fi

            echo "Sumber ditemukan! Memulai FFmpeg..."

            # Proses Streaming dengan FFmpeg
            ffmpeg -re -connect_delay 5000 -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 2000 \
              -i "$VIDEO_URL" \
              -stream_loop -1 -i logo_video.mp4 \
              -filter_complex "[1:v]colorkey=0x008100:0.1:0.1,scale=150:-1[logo]; [0:v][logo]overlay=W-w-15:15:shortest=1" \
              -c:v libx264 -preset veryfast -b:v 2500k -maxrate 2500k -bufsize 5000k \
              -c:a aac -ar 44100 -b:a 128k \
              -f flv "rtmp://a.rtmp.youtube.com/live2/${{ github.event.inputs.kunci_rtmp }}"

            echo "FFmpeg berhenti, mengulang kembali..."
            sleep 5
          done
          
