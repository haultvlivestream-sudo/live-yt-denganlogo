name: YouTube Relay Pro (Tanpa Logo - Coba Lagi)

on:
  workflow_dispatch:
    inputs:
      link_youtube:
        description: 'Link Video Utama'
        required: true
      kunci_rtmp:
        description: 'Stream Key YouTube'
        required: true

jobs:
  streaming:
    runs-on: ubuntu-latest
    steps:
      - name: Install Tooling
        run: |
          sudo apt update && sudo apt install ffmpeg jq nodejs -y
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp

      - name: Loop Streaming
        run: |
          set +e 
          
          cat << 'EOF' > cookies.txt
          ${{ secrets.YT_COOKIES }}
          EOF

          echo "Sistem mulai, tidak perlu ambil cookies baru dulu. Kita tes yang ada..."
          
          while true; do
            echo "Mengecek video sumber..."
            
            # Kita tambahkan --no-check-certificate dan bypass cache
            VIDEO_URL=$(yt-dlp --cookies cookies.txt \
              --no-check-certificate \
              --no-playlist \
              --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
              -f "best[height<=720]" -g "${{ github.event.inputs.link_youtube }}" 2>/dev/null)

            if [ -z "$VIDEO_URL" ]; then
              echo "Masih gagal ambil link. Cek lagi dalam 5 detik..."
              sleep 5
              continue
            fi

            echo "SUMBER AKTIF! Menjalankan streaming..."

            ffmpeg -re -i "$VIDEO_URL" \
              -c:v libx264 -preset veryfast -b:v 2500k \
              -pix_fmt yuv420p -g 60 -c:a aac -b:a 128k \
              -f flv "rtmp://a.rtmp.youtube.com/live2/${{ github.event.inputs.kunci_rtmp }}"

            echo "Koneksi FFmpeg terputus. Restart dalam 1 detik..."
            sleep 1
          done
          
